<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		<title>30C3 map</title>
		<link rel="stylesheet" type="text/css" media="screen" href="leaflet/leaflet.css">
		<link rel="stylesheet" type="text/css" media="screen" href="bootstrap/css/bootstrap.min.css">
		<script type="text/javascript" src="jquery/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="leaflet/leaflet.js"></script>
		<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript">
		
		//some Levenshtein-distnace code
		//http://www.merriampark.com/ld.htm, http://www.mgilleland.com/ld/ldjavascript.htm, Damerau–Levenshtein distance (Wikipedia)
			var levDist = function(s, t) {
			    var d = []; //2d matrix

			    // Step 1
			    var n = s.length;
			    var m = t.length;

			    if (n == 0) return m;
			    if (m == 0) return n;

			    //Create an array of arrays in javascript (a descending loop is quicker)
			    for (var i = n; i >= 0; i--) d[i] = [];

			    // Step 2
			    for (var i = n; i >= 0; i--) d[i][0] = i;
			    for (var j = m; j >= 0; j--) d[0][j] = j;

			    // Step 3
			    for (var i = 1; i <= n; i++) {
			        var s_i = s.charAt(i - 1);

			        // Step 4
			        for (var j = 1; j <= m; j++) {

			            //Check the jagged ld total so far
			            if (i == j && d[i][j] > 4) return n;

			            var t_j = t.charAt(j - 1);
			            var cost = (s_i == t_j) ? 0 : 1; // Step 5

			            //Calculate the minimum
			            var mi = d[i - 1][j] + 1;
			            var b = d[i][j - 1] + 1;
			            var c = d[i - 1][j - 1] + cost;

			            if (b < mi) mi = b;
			            if (c < mi) mi = c;

			            d[i][j] = mi; // Step 6

			            //Damerau transposition
			            if (i > 1 && j > 1 && s_i == t.charAt(j - 2) && s.charAt(i - 2) == t_j) {
			                d[i][j] = Math.min(d[i][j], d[i - 2][j - 2] + cost);
			            }
			        }
			    }

			    // Step 7
			    return d[n][m];
			}

			var things = { '42': { pos: [ -24.847, 4.482 ] },
						   Coffeenerds: { pos: [ 64.091, 63.105 ] },
						   'La Quadrature du Net': { pos: [ 60.63, 45.791 ] },
						   'Quality Alcohol': { pos: [ 56.17, -5.098 ] },
						   'Villa Straylight': { pos: [ 55.628, 11.162 ] },
						   'Word-lounge': { pos: [ 27.45, -2.549 ] },
						   Kids: { pos: [ 26.981, 27.51 ] },
						   Relax: { pos: [ 40.447, 53.965 ] },
						   'Hall 17': { pos: [ 54.214, 47.373 ] },
						   'Hall F': { pos: [ 11.006, -60.469 ] },
						   'Hall E': { pos: [ 1.845, -61.172 ] },
						   'Hall D': { pos: [ -7.188, -61.084 ] },
						   'Food-hacking': { pos: [ 2.021, -45.088 ] },
						   'Gängeviertel': { pos: [ -0.176, -26.279 ] },
						   'Hall G': { pos: [ 10.833, -26.191 ] },
						   'Speakers-corner': { pos: [ -8.407, 20.039 ] },
						   'Full Circle': { pos: [ -6.49, 27.861 ] },
						   Chaoswelle: { pos: [ 2.899, 46.758 ] },
						   Leiwandville: { pos: [ -24.847, 4.482 ] },
						   'Civic Summit': { pos: [ -22.837, 4.395 ] },
						   Teckids: { pos: [ -22.675, 7.119 ] },
						   pyneo: { pos: [ -22.269, 9.58 ] },
						   irish: { pos: [ -22.269, 13.008 ] },
						   OSM: { pos: [ -22.431, 17.139 ] },
						   xenomorphs: { pos: [ -24.287, 9.229 ] },
						   fabhack: { pos: [ -23.725, 15.205 ] },
						   AKV: { pos: [ -25.245, 12.92 ] },
						   DFRi: { pos: [ -25.165, 15.996 ] },
						   'Modern Poland': { pos: [ -27.137, 13.799 ] },
						   'Lübeck': { pos: [ -27.684, 2.549 ] },
						   Freifunk: { pos: [ -29.535, 2.549 ] },
						   Sendezentrum: { pos: [ -33.358, 4.307 ] },
						   Lockpicking: { pos: [ -33.064, 15.82 ] },
						   HacklabKiKa: { pos: [ -33.651, 23.643 ] },
						   Amsterdam: { pos: [ -34.886, 21.006 ] },
						   MW: { pos: [ -35.102, 25.313 ] },
						   Heaven: { pos: [ -39.572, 19.6 ] },
						   POC: { pos: [ -28.382, 29.355 ] },
						   'linux call router': { pos: [ -31.653, 30.85 ] },
						   sigrok: { pos: [ -31.728, 34.453 ] },
						   C3S: { pos: [ -28.15, 37.617 ] },
						   '#youbroketheinternet': { pos: [ -27.45, 40.078 ] },
						   WHS: { pos: [ -25.879, 39.639 ] },
						   HACAS: { pos: [ -24.687, 38.584 ] },
						   Cryptoparty: { pos: [ -18.813, 36.65 ] },
						   I2P: { pos: [ -19.311, 39.199 ] },
						   EFF: { pos: [ -18.062, 41.309 ] },
						   EDRi: { pos: [ -16.383, 45.527 ] },
						   FiFF: { pos: [ -16.046, 47.637 ] },
						   'Noisy square': { pos: [ -18.73, 45.352 ] },
						   GSM: { pos: [ -15.961, 30.674 ] },
						   'Hall 13': { pos: [ -14.179, 34.541 ] },
						   'Hall 14': { pos: [ -11.781, 38.672 ] },
						   sublab: { pos: [ -55.104, -30.19 ] },
						   'Kinky Geeks': { pos: [ -56.873, -29.839 ] },
						   C3PB: { pos: [ -53.982, -26.235 ] },
						   Mannheim: { pos: [ -55.354, -22.236 ] },
						   'Double octo*': { pos: [ -54.214, -19.907 ] },
						   'WOB Space': { pos: [ -54.496, -14.897 ] },
						   'Black Space': { pos: [ -55.154, -17.402 ] },
						   'Aussenstelle 511': { pos: [ -54.801, -11.689 ] },
						   Milliways: { pos: [ -55.204, -8.921 ] },
						   'Chaos inkl.': { pos: [ -56.729, -26.016 ] },
						   Frankfurt: { pos: [ -56.487, -22.544 ] },
						   'Byte Werk': { pos: [ -56.632, -18.237 ] },
						   'AA Hacks': { pos: [ -56.17, -15.249 ] },
						   Geheimorganisation: { pos: [ -56.559, -7.119 ] },
						   '; DROP TABLE': { pos: [ -57.327, -13.623 ] },
						   Innovalan: { pos: [ -57.16, -6.812 ] },
						   Thumb2: { pos: [ -57.821, -6.987 ] },
						   Maschinenraum: { pos: [ -58.517, -9.756 ] },
						   'Ball-pit': { pos: [ -59.378, -28.345 ] },
						   SaturnD: { pos: [ -58.379, -22.983 ] },
						   MuCCC: { pos: [ -58.379, -20.918 ] },
						   Starship: { pos: [ -58.448, -18.984 ] },
						   Bio: { pos: [ -58.402, -13.799 ] },
						   Rollwerk: { pos: [ -59.176, -13.975 ] },
						   Chaospot: { pos: [ -60.565, -29.399 ] },
						   Netz39: { pos: [ -61.228, -26.587 ] },
						   C302: { pos: [ -61.037, -23.994 ] },
						   'c-base': { pos: [ -60.196, -16.743 ] },
						   '3D': { pos: [ -61.355, -20.742 ] },
						   'Hall 3': { pos: [ -61.27, -16.172 ] },
						   Copter: { pos: [ -60.93, -11.118 ] },
						   BlinkenArea: { pos: [ -60.196, -7.163 ] },
						   Darmstadt: { pos: [ -61.939, -29.268 ] },
						   'shack space': { pos: [ -62.755, -31.685 ] },
						   'Binary Kitchen': { pos: [ -62.39, -26.895 ] },
						   CCCFR: { pos: [ -62.083, -23.774 ] },
						   Mainframe: { pos: [ -62.512, -20.654 ] },
						   MFK: { pos: [ -62.411, -17.93 ] },
						   Foobar: { pos: [ -62.329, -14.546 ] },
						   Forth: { pos: [ -62.329, -10.898 ] },
						   compass: { pos: [ -63.332, -26.938 ] },
						   Warsaw: { pos: [ -63.392, -23.159 ] },
						   Warpzone: { pos: [ -63.588, -18.896 ] },
						   'Kölner Kreis': { pos: [ -63.253, -15.337 ] },
						   'DIY Audio': { pos: [ -63.214, -11.294 ] },
						   Flipdot: { pos: [ -63.957, -32.212 ] },
						   Smartcards: { pos: [ -63.879, -29.487 ] },
						   CONFidence: { pos: [ -64.378, -27.026 ] },
						   Entropolis: { pos: [ -64.225, -20.918 ] },
						   'Labor 23': { pos: [ -64.321, -13.359 ] },
						   Fail0verflow: { pos: [ -64.868, -23.027 ] },
						   Geraffel: { pos: [ -64.091, 13.359 ] },
						   'Hacker Tours': { pos: [ -64.718, 17.095 ] },
						   C4: { pos: [ -65.33, 15.469 ] },
						   c3le: { pos: [ -65.821, -2.241 ] },
						   Niwohlos: { pos: [ -66.601, 0.176 ] },
						   Magarathea: { pos: [ -66.653, 5.669 ] },
						   Salzburg: { pos: [ -66.302, 11.777 ] },
						   Chaosdorf: { pos: [ -66.302, 14.37 ] },
						   Subraum: { pos: [ -66.947, -2.461 ] },
						   Spline: { pos: [ -67.542, -1.362 ] },
						   Eindbazen: { pos: [ -67.357, 1.362 ] },
						   Aachen: { pos: [ -67.289, 3.735 ] },
						   '/dev/lol': { pos: [ -66.878, 10.107 ] },
						   Info: { pos: [ -63.115, 18.765 ] },
						   Food: { pos: [ -53.094, 10.986 ] },
						   Wardrobe: { pos: [ -50.709, 30.103 ] },
						   'T-Shirt Sale': { pos: [ -52.429, 36.87 ] },
						   Speakerregistration: { pos: [ -47.04, 54.492 ] },
						   'Hall 6': { pos: [ -66.018, 43.594 ] },
						   'Revolution #9': { pos: [ -70.787, 27.949 ] },
						   'c-shuttle': { pos: [ -69.473, 28.301 ] },
						   Exit: { pos: [ -61.606, 56.777 ] },
						   Entry: { pos: [ -53.645, 69.961 ] },
						   'Hall 1': { pos: [ 12.897, 11.602 ] },
						   'Hall 2': { pos: [ 21.289, 40.43 ] },
						   Crypotcat: { pos: [ -18.73, 45.352 ] },
						   'Torservers.net': { pos: [ -18.73, 45.352 ] },
						   'Hart Voor InternetVrijheid': { pos: [ -18.73, 45.352 ] },
						   Puscii: { pos: [ -18.73, 45.352 ] },
						   'USE OTR!': { pos: [ -18.73, 45.352 ] },
						   'Wikileaks-Press': { pos: [ -18.73, 45.352 ] },
						   'Anarchist Village': { pos: [ -18.73, 45.352 ] },
						   Greenhost: { pos: [ -18.73, 45.352 ] },
						   'Tactical Tech': { pos: [ -18.73, 45.352 ] },
						   'Open Knowledge Foundation': { pos: [ -18.73, 45.352 ] },
						   'LEAP Encryption Access Project': { pos: [ -18.73, 45.352 ] },
						   'GlobaLeaks Projekt + Hermes Center': { pos: [ -18.73, 45.352 ] },
						   Mailpile: { pos: [ -18.73, 45.352 ] } };

			$(function () {
				var marker;
				var Icon = L.icon({
					iconUrl: 'leaflet/images/marker-icon-red.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41],
					shadowUrl: 'leaflet/images/marker-shadow.png'
				})

				var res = $('#result');
				var search = $('#searchtext');
				function performSearch() {
					var searchstring = search.val().toLowerCase();
					for(var i in things)
						if (things.hasOwnProperty(i))
							things[i].dist = levDist(searchstring, i);	
					var searchresult = Object.keys(things).sort(function(a,b){
										return things[a].dist - things[b].dist });
					var html = '';
					for (var i = 0; i < Math.min(searchresult.length, 10); i++) {
						html += '<li>'+searchresult[i]+'</li>';
					}

					if (html != '') res.show();
						else res.hide();
					$('#result ul').html(html);
					$('#result ul li:first').addClass('selected');
					$('#result ul li').click(function(){select($(this).text())});
					res.css({
						top: search.position().top + search.height() + 10,
						left: search.position().left
					});
				}

				function select(text){
					addMarker(things[text].pos);
					$('#btnmarker').addClass('active');
					setHash();
					res.hide();
				}

				$('#searchtext').keypress(function(e) {
					switch (e.keyCode) {
						case 13: // Enter
							var selected = $('#result ul li.selected').first();
							if (selected) selected.click();
						break;
						default:
							setTimeout(performSearch, 10);
					}
				});

				var map = L.map('map', {
					minZoom: 0,
					maxZoom: 6,
					zoom: 1,
					center: [0,0],
					maxBounds: [[-80,-180],[80,180]]
				});
				
				L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
				    attribution: '<a href="https://events.ccc.de/congress/2013/">30C3</a> | Improve the code on <a href="https://github.com/MichaelKreil/30c3-map">GitHub</a>!',
				    noWrap: true
				}).addTo(map);

				$('#btnmarker').on('click', function (event) {
					setTimeout(function () {
						var button = $(event.currentTarget);
						if (button.hasClass('active')) {
							addMarker();
						} else {
							removeMarker();
						}
					},0);
				})

				setTimeout(getHash, 0);

				function getHash() {
					var hash = window.location.hash;
					if (hash) {
						hash = hash.match(/([\-0-9]*)_([\-0-9]*)/);
						if (hash) {
							var pos = [
								parseInt(hash[1], 10)/1000,
								parseInt(hash[2], 10)/1000
							];
							addMarker(pos);
							$('#btnmarker').addClass('active');
						}
					}
				}

				function addMarker(pos) {
					removeMarker();
					if (pos) {
						map.setView(pos, 3);
						marker = L.marker(pos, {
							icon: Icon
						});
						marker.addTo(map);
					} else {
						marker = L.marker(map.getCenter(), {
							draggable: true,
							opacity: 0.7,
							icon: Icon
						});
						marker.on('dragend', setHash);
						setHash();
						marker.addTo(map);
						$('#footer').addClass('visible');
					}
				}

				function removeMarker() {
					if (marker) {
						map.removeLayer(marker);
						marker = false;
						$('#footer').removeClass('visible');
						setHash();
					}
				}

				function setHash() {
					if (marker) {
						var pos = marker.getLatLng();
						pos = [
							(1000*pos.lat).toFixed(0),
							(1000*pos.lng).toFixed(0)
						].join('_');
						window.location.hash = pos;
						$('#url').val('http://michaelkreil.github.io/30c3-map/#'+pos);
					} else {
						window.location.hash = '';
					}
				}

				$('#url').on('click', function () {
					$('#url').select();
				})

			})
		</script>
		<style type="text/css">
			html, body, #map {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}

			#map {
				position: absolute;
				background: #fff;
				top: 52px;
			}

			#header {
				padding: 0px;
				position: absolute;
				top: 0px;
				left: 0px;
				right: 0px;
				width: 100%;
				background: #fff;
				height: 52px;
			}

			#searchtext {
				position: absolute;
				width: auto;
				height: auto;
				margin: 0;
				top: 8px;
				left: 8px;
				right: 52px;
				bottom: 8px;
				font-size: 16px;
			}

			#result {
				display: none;
				margin: 0;
				padding: 0;
				z-index: 9999;
				position: absolute;
				width: 50%;
				max-width: 494px;
				border-radius: 5px;
				border: solid #CCC 2px;
			}

			#result ul li,
			#result ul {
				margin: 0;
				padding: 0 3px;
				background-color: #EEE;
				list-style:none;
				cursor: pointer;
				cursor: hand;
			}

			li.selected {
				font-weight: bold;
			}
			.btn3m {
				position: absolute;
				top: 8px;
				padding: 5px;
			}
			#btnsearch {
				right: 52px;
			}
			#btnmarker {
				right: 8px;
			}
			#search-icon {
				width: 24px;
				height: 24px;
				background: url(images/search.png) no-repeat;
				background-position: center;
				background-size: auto 100%;
			}
			#marker-icon {
				width: 24px;
				height: 24px;
				background: url(images/marker-icon-red.png) no-repeat;
				background-position: center;
				background-size: auto 100%;
			}
			.active #marker-icon {
				background-image: url(images/marker-icon-grey.png);
			}
			#footer {
				display: none;
				position: absolute;
				left:0px;
				right:0px;
				bottom:0px;
				height:52px;
				text-align: center;
				background: rgba(255,255,255,0.8)
			}
			#footer.visible {
				display: block;
			}
			#url {
				margin-top: 8px;
				width: 100%;
				max-width: 800px;
				height:34px;
				font-size: 16px;
			}

		</style>
		<meta name="HandheldFriendly" content="True" />
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
	</head>
	<body>
		<div style="display:none">Zoomable map of the 30c3. You can also add a marker and send the deep link to share a meeting point.</div>
		<div id="header">
			<input id="searchtext" type="text" />
			<div id="result"><ul></ul></div>
			<!--
			<div id="btnsearch" class="btn btn3m" data-toggle="button"><div id="search-icon"></div></div>
		-->
			<div id="btnmarker" class="btn btn3m" data-toggle="button"><div id="marker-icon"></div></div>
		</div>
		<div id="map">
		</div>
		<div id="footer"><input type="text" id="url" /></div>
	</body>
</html>